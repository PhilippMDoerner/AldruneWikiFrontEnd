<div class="main">
    <article class="mb-5">
        <!-- Heading -->
        <div *ngIf="(isInUpdateState() || isInOutdatedUpdateState()) && userModel; else createState">
            <app-edit-toggle 
            [isInUpdateState]=true 
            [link]="updateCancelUrl"
            ></app-edit-toggle>

            <h2 class="text-center">
                Updating Character {{ userModel.name }}
            </h2>
        </div>

        <!-- Connections -->
        <div *ngIf="isInUpdateState()">
            <h4 class="mb-0"> Classes </h4>
            <hr class="white-separator">
    
            <div id="player-classes" class="mb-5" *ngIf="userModel">
                <span class="badge badge-secondary mr-3" *ngFor="let connection of userModel.player_class_connections">
                    {{ connection.player_class_details.name }}
                    <span class="ml-2 fa fa-trash icon" (click)="deletePlayerClassConnection(connection)"></span>
                </span>
    
                <!-- Add-Class-Badge -->
                <app-inline-create-button
                class="full-sized"
                [labelText]="'Add Class'"
                (click)="toggleConnectionCreateState()" 
                *ngIf="!isCharacterConnectionCreationState; else connectionForm"
                >     
                </app-inline-create-button>
            </div>    
        </div>

        <!-- Memberships -->
        <div *ngIf="isInUpdateState()">
            <h4 class="mb-0"> Memberships </h4>
            <hr class="white-separator">
    
            <div id="organizations" class="mb-5" *ngIf="userModel">
                <span class="badge badge-secondary mr-3" *ngFor="let membership of userModel.organizations">
                    {{ membership.name }}
                    <span class="ml-2 fa fa-trash icon" (click)="deleteOrganizationMembership(membership)"></span>
                </span>
                    
                <!-- Add-Organization-Membership-Badge -->
                <app-inline-create-button
                class="full-sized"
                [labelText]="'Add Membership'"
                (click)="toggleOrganizationMembershipCreateState()" 
                *ngIf="!isOrganizationMembershipCreationState; else organizationMembershipForm"
                >     
                </app-inline-create-button>
            </div>    
        </div>
        <!-- Form -->
        <h4 class="mb-0"> Character Data </h4>
        <hr class="white-separator">

        <app-formly-formcontainer
        *ngIf="isInUpdateState() || isInCreateState()"
        [model]="userModel" 
        [fields]="formlyFields" 
        (formlySubmit)="onSubmit()" 
        (formlyCancel)="onCancel()"
        ></app-formly-formcontainer>

        <app-compare-form-container
        *ngIf="isInOutdatedUpdateState()"
        [formlyFields]="formlyFields"
        [modelFromUser]="userModel"
        [modelFromServer]="serverModel"
        (updateSubmit)="onSubmit()"
        (cancel)="onCancel()"
        ></app-compare-form-container>
    </article>
</div>

<ng-template #createState>
    <app-edit-toggle 
    [isInUpdateState]=true 
    [link]="creationCancelUrl"
    ></app-edit-toggle>

    <h2 class="text-center">
        Creating a new character
    </h2>
</ng-template>


<ng-template #connectionForm>
    <!-- Form for Creating Player Class Connections -->
    <form class="d-inline-flex align-items-center" (submit)="createPlayerClassConnection(connectionModel)">
        <select class="form-control d-inline-block" name="connection" id="connection" [(ngModel)]="connectionModel.player_class">
            <option 
            *ngFor="let playerClass of playerClasses" 
            value="{{playerClass.pk}}" 
            [attr.disabled]="hasConnection(playerClass) ? true : null"
            >
                {{playerClass.name}}
            </option>
        </select>

        <i class="fa fa-times icon mx-2 fa-1-5x" (click)="toggleConnectionCreateState()"></i>
        <button type="submit"> <i class="fa fa-check icon fa-1-5x"></i> </button>
    </form>
</ng-template>

<ng-template #organizationMembershipForm>
    <!-- Form for creating Memberships to Organizations -->
    <form class="d-inline-flex align-items-center" (submit)="createOrganizationMembership(membershipModel)">
        <select class="form-control d-inline-block" name="membership" id="membership" [(ngModel)]="membershipModel.organization_id">
            <option 
            *ngFor="let organization of organizations" 
            value="{{organization.pk}}" 
            [attr.disabled]="hasMembership(organization) ? true : null"
            >
                {{organization.name}}
            </option>
        </select>

        <i class="fa fa-times icon mx-2 fa-1-5x" (click)="toggleOrganizationMembershipCreateState()"></i>
        <button type="submit"> <i class="fa fa-check icon fa-1-5x"></i> </button>
    </form>
</ng-template>